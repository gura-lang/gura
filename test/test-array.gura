#!/usr/bin/env gura
import(helper.test) {*}

funcs = [
	array@int8
	array@uint8
	array@int16
	array@uint16
	array@int32
	array@uint32
	array@int64
	array@uint64
	array@float
	array@double
	array
]

FormatArray(fmt:string, array:array):map = {
	if (array.ndim == 1) {
		'[' + format(fmt, array.each()).join(' ') + ']'
	} else {
		'[' + FormatArray(fmt, array.each()).join() + ']'
	}
}

PrintArray(fmt:string, array:array) = println(FormatArray(fmt, array))

testcase('properties') {
	x = array.zeros([2, 3, 4])
	tester(`x)
	tester(`x.elembytes)
	tester(`x.elemtype)
	tester(`(x.memoryid == x.offset(1).memoryid))
	tester(`x.ndim)
	tester(`x.p)
	tester(`x.shape)
	tester(`x.size)
	tester(`x.T)
}
testcase('constructor') {
	funcs.each {|func|
		println(func)
		x = func.zeros([30])
		println(x[0..29].each().join(' '))
		x = func.ones([30])
		println(x[0..29].each().join(' '))
		x = func([0..29])
		println(x[0..29].each().join(' '))
		println(x.each().join(' '))
		x.each {|n| printf('%d ', n)}, println()
		x = func(0..29)
		println(x[0..29].each().join(' '))
		println(func.zeros([3, 4]))
		println(func.zeros([2, 3, 4]))
		println(func.ones([3, 4]))
		println(func.ones([2, 3, 4]))
		randseed(0), println(func.rands([12]))
		randseed(0), println(func.rands([3, 4]))
		randseed(0), println(func.rands([2, 3, 4]))
		randseed(0), println(func.rands([12], 100))
		randseed(0), println(func.rands([3, 4], 100))
		randseed(0), println(func.rands([2, 3, 4], 100))
		randseed(0), println(func.rands@normal([12]))
		randseed(0), println(func.rands@normal([3, 4]))
		randseed(0), println(func.rands@normal([2, 3, 4]))
		randseed(0), println(func.rands@normal([12], 10))
		randseed(0), println(func.rands@normal([3, 4], 10))
		randseed(0), println(func.rands@normal([2, 3, 4], 10))
		randseed(0), println(func.rands@normal([12], 10, 6))
		randseed(0), println(func.rands@normal([3, 4], 10, 6))
		randseed(0), println(func.rands@normal([2, 3, 4], 10, 6))
	}
}
testcase('cast to list') {
	funcs.each {|func|
		println(func)
		x:list = func([0..29])
		println(x.join(' '))
	}
}
testcase('cast from list') {
	x:array@int8 = [0..29]
	PrintArray('%2d', x)
	x:array@uint8 = [0..29]
	PrintArray('%2d', x)
	x:array@int16 = [0..29]
	PrintArray('%2d', x)
	x:array@uint16 = [0..29]
	PrintArray('%2d', x)
	x:array@int32 = [0..29]
	PrintArray('%2d', x)
	x:array@uint32 = [0..29]
	PrintArray('%2d', x)
	x:array@float = [0..29]
	PrintArray('%2d', x)
	x:array@double = [0..29]
	PrintArray('%2d', x)
}
testcase('cast from iterator') {
	x:array@int8 = 0..29
	PrintArray('%2d', x)
	x:array@uint8 = 0..29
	PrintArray('%2d', x)
	x:array@int16 = 0..29
	PrintArray('%2d', x)
	x:array@uint16 = 0..29
	PrintArray('%2d', x)
	x:array@int32 = 0..29
	PrintArray('%2d', x)
	x:array@uint32 = 0..29
	PrintArray('%2d', x)
	x:array@float = 0..29
	PrintArray('%2d', x)
	x:array@double = 0..29
	PrintArray('%2d', x)
}
testcase('head/tail') {
	funcs.each {|func|
		println(func)
		x = func([0..29])
		PrintArray('%2d', x)
		PrintArray('%2d', x.head(12))
		PrintArray('%2d', x.tail(12))
		PrintArray('%2d', x.head(30))
		PrintArray('%2d', x.tail(30))
		try {
			PrintArray('%2d', x.head(31))
		} catch {|e|
			println('expected error occurs: ', e.text)
		}
		try {
			PrintArray('%2d', x.tail(31))
		} catch {|e|
			println('expected error occurs: ', e.text)
		}
		x = func([
			[[0, 1, 2, 3], [4, 5, 6, 7]], [[8, 9, 10, 11], [12, 13, 14, 15]],
			[[16, 17, 18, 19], [20, 21, 22, 23]], [[24, 25, 26, 27], [28, 29, 30, 31]]])
		println(x)
		printf('head(%d):\n%s\n', 0..4, x.head(0..4))
		printf('tail(%d):\n%s\n', 0..4, x.tail(0..4))
		printf('offset(%d):\n%s\n', 0..4, x.offset(0..4))
	}
}
testcase('offset') {
	funcs.each {|func|
		println(func)
		x = func([0..29])
		PrintArray('%2d', x)
		PrintArray('%2d', x.offset(3))
		PrintArray('%2d', x.offset(27))
		PrintArray('%2d', x.offset(29))
		PrintArray('%2d', x.offset(30))
		try {
			PrintArray('%2d', x.offset(31))
		} catch {|e|
			println('expected error occurs: ', e.text)
		}
	}
}
testcase('paste') {
	funcs.each {|func|
		println(func)
		x = func([0..29])
		y = func([90..99])
		PrintArray('%2d', x)
		x.paste(0, y)
		PrintArray('%2d', x)
		x.paste(20, y)
		PrintArray('%2d', x)
		try {
			x.paste(21, y)
		} catch {|e|
			println('expected error occurs: ', e.text)
		}
		x.paste(12, y.offset(3))
		PrintArray('%2d', x)
	}	
}
testcase('initializer') {
	funcs = [
		array@int8
		array@uint8
		array@int16
		array@uint16
		array@int32
		array@uint32
		array@int64
		array@uint64
		array@float
		array@double
	]
	funcs.each {|func|
		x = func {
			0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
			16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31,
		}
		print(function.getname(func), ':')
		PrintArray('%2d', x)
	}
	funcs.each {|func|
		x = func {
			{0, 1, 2, 3, 4, 5, 6, 7}, {8, 9, 10, 11, 12, 13, 14, 15},
			{16, 17, 18, 19, 20, 21, 22, 23}, {24, 25, 26, 27, 28, 29, 30, 31},
		}
		print(function.getname(func), ':')
		PrintArray('%2d', x)
	}
	funcs.each {|func|
		x = func {
			{{0, 1, 2, 3}, {4, 5, 6, 7}}, {{8, 9, 10, 11}, {12, 13, 14, 15}},
			{{16, 17, 18, 19}, {20, 21, 22, 23}}, {{24, 25, 26, 27}, {28, 29, 30, 31}},
		}
		print(function.getname(func), ':')
		PrintArray('%2d', x)
	}
}
testcase('operator') {
	funcs.each {|func|
		println(func)
		a = func([2..11])
		b = func([1..10])
		a_short = func([2..4])
		b_short = func([1..3])
		print('+a = '), PrintArray('%2d', +a)
		print('-a = '), PrintArray('%2d', -a)
		print('a + b = '), PrintArray('%2d', a + b)
		print('a - b = '), PrintArray('%2d', a - b)
		print('a * b = '), PrintArray('%2d', a * b)
		print('a / b = '), PrintArray('%2d', a / b)
		print('a % b = '), PrintArray('%2d', a % b)
		print('a ** b = '), PrintArray('%2d', a_short ** b_short)
		print('a + 3 = '), PrintArray('%2d', a + 3)
		print('a - 3 = '), PrintArray('%2d', a - 3)
		print('a * 3 = '), PrintArray('%2d', a * 3)
		print('a / 3 = '), PrintArray('%2d', a / 3)
		print('a % 3 = '), PrintArray('%2d', a % 3)
		print('a ** 3 = '), PrintArray('%2d', a ** 3)
		print('3 + b = '), PrintArray('%2d', 3 + b)
		print('3 - b = '), PrintArray('%2d', 3 - b)
		print('3 * b = '), PrintArray('%2d', 3 * b)
		print('3 / b = '), PrintArray('%2d', 3 / b)
		print('3 / b = '), PrintArray('%2d', 3 % b)
		print('3 ** b = '), PrintArray('%2d', 3 ** b)
		print('a & b = ')
		try {
			PrintArray('%2d', a & b)
		} catch {
			println('error')
		}
		print('a | b = ')
		try {
			PrintArray('%2d', a | b)
		} catch {
			println('error')
		}
		print('a ^ b = ')
		try {
			PrintArray('%2d', a ^ b)
		} catch {
			println('error')
		}
		print('a & 3 = ')
		try {
			PrintArray('%2d', a & 3)
		} catch {
			println('error')
		}
		print('a | 3 = ')
		try {
			PrintArray('%2d', a | 3)
		} catch {
			println('error')
		}
		print('a ^ 3 = ')
		try {
			PrintArray('%2d', a ^ 3)
		} catch {
			println('error')
		}
		print('3 & b = ')
		try {
			PrintArray('%2d', 3 & b)
		} catch {
			println('error')
		}
		print('3 | b = ')
		try {
			PrintArray('%2d', 3 | b)
		} catch {
			println('error')
		}
		print('3 ^ b = ')
		try {
			PrintArray('%2d', 3 ^ b)
		} catch {
			println('error')
		}
		println()
	}
}
testcase('cast to memory') {
	f(m:memory) = {
		printf('%dbytes\n', m.size)
		m.array@uint8().dump()
	}
	funcs.each {|func|
		println(func)
		f(func([0..15]))
	}
}
testcase('error for infinite iterator') {
	try {
		x:array@int32 = 0..
	} catch {|e|
		println('expected error occurs: ', e.text)
	}
}
testcase('divide by zero') {
	funcs.each {|func|
		x = func([1, 2, 3])
		y = func([1, 0, 3])
		println(func)
		tester(`(x / y))
		tester(`(x / 0))
		tester(`(2 / y))
	}
}
testcase('sum/average') {
	funcs.each {|func|
		println(func)
		x = func([1..10])
		println('sum = ', x.sum())
		println('avg = ', x.average())
	}	
}
testcase('identity') {
	funcs.each {|func|
		println(func)
		x = func.identity(1)
		println((x.each():flat).fold(1):*join(' '))
		x = func.identity(2)
		println((x.each():flat).fold(2):*join(' '))
		x = func.identity(3)
		println((x.each():flat).fold(3):*join(' '))
		x = func.identity(5)
		println((x.each():flat).fold(5):*join(' '))
	}
}
testcase('modification on referenced instance') {
	x = array@int32([[1, 2], [3, 4], [5, 6]])
	println(x)
	x.flatten {|xref|
		println(xref)
		xref[3] = 3333
		println(xref)
	}
	println(x)
}
testcase('array#flatten()') {
	tester(`array@int32([[1, 2], [3, 4], [5, 6]]).flatten())
	tester(`array@int32([[[1, 2], [3, 4], [5, 6]], [[7, 8], [9, 10], [11, 12]]]).flatten())
	tester(`array@int32([[[1, 2], [3, 4], [5, 6]], [[7, 8], [9, 10], [11, 12]]])[1].flatten())
}
testcase('array#reshape()') {
	x = array@int32([0..23])
	println(x)
	tester(`x.reshape([nil]))
	tester(`x.reshape([24]))
	tester(`x.reshape([1, 24]))
	tester(`x.reshape([8, 3]))
	tester(`x.reshape([4, 2, 3]))
	tester(`x.reshape([8, nil]))
	tester(`x.reshape([nil, 3]))
	tester(`x.reshape([nil, 2, 3]))
	tester(`x.reshape([4, nil, 3]))
	tester(`x.reshape([4, 2, nil]))
	tester(`x.reshape([4, nil, nil]))
	tester(`x.reshape([4, 2, 4]))
}
testcase('array#transpose()') {
	func(src:array, axesTbl[]) = {
		println(src)
		for (axes in axesTbl) {
			try {
				result = src.transpose(axes)
				println(result.shape):nomap
				println(result)
			} catch {|e|
				println(e.text)
			}
		}
	}
	src = array@int32([1..12]).reshape([3, 4])
	axesTbl = [[0, 1], [1, 0], [0, 2], [], [0], [0, 0]]
	func(src, axesTbl)
	src = array@int32([1..24]).reshape([2, 3, 4])
	axesTbl = [[0, 1, 2], [0, 2, 1], [1, 0, 2], [0, 1, 3], [], [0], [0, 1], [0, 1, 1]]
	func(src, axesTbl)
}
testcase('array#T') {
	func(src:array) = {
		println(src)
		try {
			result = src.T
			println(result.shape):nomap
			println(result)
		} catch {|e|
			println(e.text)
		}
	}
	src = array@int32([1..12]).reshape([3, 4])
	func(src)
}
testcase('array.dot()') {
	a = array {1, 5, 9}
	b = array {5, 2}
	c = array {{7, 4, -1}, {3, 0, 5}}
	d = array {{5, 2}, {3, 1}, {4, -1}}
	e = array {{8, 4, 2}, {1, 3, -6}, {-7, 0, 5}}
	tester(`array.dot(a, d))
	tester(`array.dot(a, e))
	tester(`array.dot(b.reshape([2, 1]), a.reshape([1, 3])))
	tester(`array.dot(c, d))
	tester(`array.dot(c, e))
	tester(`array.dot(d, b))
	tester(`array.dot(d, c))
	tester(`array.dot(e, d))
	tester(`(a |.| d))
	tester(`(a |.| e))
	tester(`(b.reshape([2, 1]) |.| a.reshape([1, 3])))
	tester(`(c |.| d))
	tester(`(c |.| e))
	tester(`(d |.| b))
	tester(`(d |.| c))
	tester(`(e |.| d))
}
testcase('array.invert()') {
	tester(`array([[1, 1, -1], [-2, 0, 1], [0, 2, 1]]).invert())
	tester(`array([[1, 2, 1], [2, 1, 0], [1, 1, 2]]).invert())
	tester(`array([
		[[1, 1, -1], [-2, 0, 1], [0, 2, 1]],
		[[1, 2, 1], [2, 1, 0], [1, 1, 2]]]).invert())
}
testcase('properties') {
	funcs.each {|func|
		println(func)
		x = func.zeros([4, 2, 3])
		println('elembytes: ', x.elembytes)
		println('elemtype: ', x.elemtype)
		println('ndim: ', x.ndim)
		println('shape: ', x.shape):nomap
		println('size: ', x.size)
	}
}
testcase('array as an alias of array@double') {
	randseed(0)
	tester(`array.identity(5))
	tester(`array.interval(0, 8, 5))
	tester(`array.ones([3, 4]))
	tester(`array.rands([3, 4], 10))
	tester(`array.rands@normal([3, 4], 3, 5))
	tester(`array.zeros([3, 4]))
}
testcase('constructor with initial values') {
	funcs.each {|func|
		println(func)
		println(func([]))
		println(func([[]]))
		println(func([[], []]))
		println(func([[], [], []]))
		println(func([1]))
		println(func([1, 2]))
		println(func([1, 2, 3]))
		println(func([1, 2, 3, 4]))
		println(func([[1, 2], [3, 4]]))
		println(func([[1, 2, 3], [4, 5, 6]]))
		println(func([1].each()))
		println(func([1, 2].each()))
		println(func([1, 2, 3].each()))
		println(func([1, 2, 3, 4].each()))
		//println(func([[1, 2], [3, 4]].each()))
		//println(func([[1, 2, 3], [4, 5, 6]].each()))
		println(func(['1']))
		println(func(['1', '2']))
		println(func(['1', '2', '3']))
		println(func(['1', '2', '3', '4']))
		println(func([['1', '2'], ['3', '4']]))
		println(func([['1', '2', '3'], ['4', '5', '6']]))
		println(func(['012', '0x12']))
		println(func(['1'].each()))
		println(func(['1', '2'].each()))
		println(func(['1', '2', '3'].each()))
		println(func(['1', '2', '3', '4'].each()))
	}
}
testcase('dimension mismatch error') {
	tester(`(array {1, 2, 3} + array {1, 2}))
	tester(`(array {{1, 2}, {3, 4}} + array {{1, 2, 3}, {4, 5, 6}}))
	tester(`(array {{1, 2}, {3, 4}} |.| array {{1, 2, 3}, {4, 5, 6}, {7, 8, 9}}))
}
testcase('range') {
	func = array@int32
	println(func)
	tester(`func.range(10))
	tester(`func.range(0, 10))
	tester(`func.range(0, -10))
	tester(`func.range(3, 10))
	tester(`func.range(3, -10))
	tester(`func.range(-3, 10))
	tester(`func.range(-3, -10))
	tester(`func.range(3, 10, 2))
	tester(`func.range(3, -10, -2))
	tester(`func.range(-3, 10, 2))
	tester(`func.range(-3, -10, -2))
	tester(`func.range(3, 10, -2))
	tester(`func.range(3, -10, 2))
	tester(`func.range(3, 10, 0))
}
testcase('sum') {
	[
		array {}
		array.range(6)
		array.range(6).reshape([3, 2])
		array.range(24).reshape([4, 3, 2])
		array.range(48).reshape([2, 4, 3, 2])
	].each {|a|
		println('----')
		println(a)
		tester(`a.sum())
		tester(`a.sum(0))
		tester(`a.sum(1))
		tester(`a.sum(2))
		tester(`a.sum(3))
		tester(`a.sum(4))
	}
}
testcase('average') {
	[
		array {}
		array.range(6)
		array.range(6).reshape([3, 2])
		array.range(24).reshape([4, 3, 2])
		array.range(48).reshape([2, 4, 3, 2])
	].each {|a|
		println('----')
		println(a)
		tester(`a.average())
		tester(`a.average(0))
		tester(`a.average(1))
		tester(`a.average(2))
		tester(`a.average(3))
		tester(`a.average(4))
	}
}
testcase('constructor with elemtype') {
	[
		`int8, `uint8, `int16, `uint16, `int32, `uint32, `int64, `uint64, `float, `double,
		`int9
	].each {|elemtype|
		try {
			x = array(elemtype => elemtype) {{0, 1, 2}, {3, 4, 5}}
			println(x.elemtype, ': ', x)
		} catch {|e|
			println(e.text)
		}
	}
}
testcase('operation test on array with offset') {
	x = array@int32.range(64)
	x_off = x.offset(32)
	tester(`x_off)
	tester(`x_off.flatten())
	tester(`x_off.reshape([4, 8]))
	tester(`x_off.head(16))
	tester(`x_off.tail(16))
	tester(`x_off.offset(16))
	tester(`x_off.each().head(16):list)
}
testcase('tranpsose() and T') {
	array.range(12) {|x|
		tester(`x)
		tester(`x.transpose())
		tester(`x.T)
	}
	println('----')
	array.range(12).reshape([3, 4]) {|x|
		tester(`x)
		tester(`x.transpose())
		tester(`x.T)
	}
	println('----')
	array.range(24).reshape([2, 3, 4]) {|x|
		tester(`x)
		tester(`x.transpose())
		tester(`x.T)
	}
	println('----')
	array.range(72).reshape([3, 2, 3, 4]) {|x|
		tester(`x)
		tester(`x.transpose())
		tester(`x.T)
	}
}
testcase('array.rotation()') {
	tester(`array.rotation(0))
	tester(`array.rotation(0, 2))
	tester(`array.rotation(0, 2, 3))
	tester(`array.rotation(math.pi / 6))
	tester(`array.rotation(30):deg)
}
testcase('array.rotation@x()') {
	tester(`array.rotation@x(0))
	tester(`array.rotation@x(0, 2))
	tester(`array.rotation@x(0, 2, 3))
	tester(`array.rotation@x(0, 2, 3, 4))
	tester(`array.rotation@x(math.pi / 6))
	tester(`array.rotation@x(30):deg)
}
testcase('array.rotation@y()') {
	tester(`array.rotation@y(0))
	tester(`array.rotation@y(0, 2))
	tester(`array.rotation@y(0, 2, 3))
	tester(`array.rotation@y(0, 2, 3, 4))
	tester(`array.rotation@y(math.pi / 6))
	tester(`array.rotation@y(30):deg)
}
testcase('array.rotation@z()') {
	tester(`array.rotation@z(0))
	tester(`array.rotation@z(0, 2))
	tester(`array.rotation@z(0, 2, 3))
	tester(`array.rotation@z(0, 2, 3, 4))
	tester(`array.rotation@z(math.pi / 6))
	tester(`array.rotation@z(30):deg)
}
testcase('array.scaling()') {
	tester(`array.scaling(0, 0))
	tester(`array.scaling(0, 0, 0))
	tester(`array.scaling(2, 3))
	tester(`array.scaling(2, 3, 4))
}
testcase('array.translation()') {
	tester(`array.translation(0, 0))
	tester(`array.translation(0, 0, 0))
	tester(`array.translation(2, 3))
	tester(`array.translation(2, 3, 4))
}
testcase('array#transpose() sharing memory') {
	testcases = [
		array {}
		array.range(2).reshape([nil])
		array.range(2).reshape([1, nil])
		array.range(2).reshape([nil, 1])
		array.range(8).reshape([nil])
		array.range(8).reshape([1, nil])
		array.range(8).reshape([nil, 1])
		array.range(12).reshape([4, 1, nil])
		array.range(12).reshape([4, nil, 1])
		array.range(24).reshape([2, 4, 1, nil])
		array.range(24).reshape([2, 4, nil, 1])
		array.range(4).reshape([2, nil])
		array.range(4).reshape([2, nil])
		array.range(12).reshape([3, nil])
		array.range(12).reshape([3, nil])
	]
	for (x in testcases) {
		println('x =')
		println(x)
		println('x.T =')
		print(xt = x.T)
		println(' .. ', cond(x.memoryid == xt.memoryid, 'shared', 'not-shared'))
		if (x.ndim == 1) {
			println('transpose([0]) =')
			print(xt = x.transpose([0]))
			println(' .. ', cond(x.memoryid == xt.memoryid, 'shared', 'not-shared'))
		} elsif (x.ndim == 2) {
			println('transpose([1, 0]) =')
			print(xt = x.transpose([1, 0]))
			println(' .. ', cond(x.memoryid == xt.memoryid, 'shared', 'not-shared'))
		} elsif (x.ndim == 3) {
			println('transpose([0, 2, 1]) =')
			print(xt = x.transpose([0, 2, 1]))
			println(' .. ', cond(x.memoryid == xt.memoryid, 'shared', 'not-shared'))
		} elsif (x.ndim == 4) {
			println('transpose([0, 1, 3, 2]) =')
			print(xt = x.transpose([0, 1, 3, 2]))
			println(' .. ', cond(x.memoryid == xt.memoryid, 'shared', 'not-shared'))
			println('transpose([1, 0, 3, 2]) =')
			print(xt = x.transpose([1, 0, 3, 2]))
			println(' .. ', cond(x.memoryid == xt.memoryid, 'shared', 'not-shared'))
		}
		println('----')
	}
}
testcase('sharing collapses after assignment') {
	x1 = array.range(12).reshape([4, nil])
	println(x1)
	x2 = x1.offset(0)
	println(cond(x1.memoryid == x2.memoryid, 'shared', 'not-shared'))
	x2[0] = 3
	println(cond(x1.memoryid == x2.memoryid, 'shared', 'not-shared'))
	x2 = x1.offset(0)
	println(cond(x1.memoryid == x2.memoryid, 'shared', 'not-shared'))
	x1[0] = 3
	println(cond(x1.memoryid == x2.memoryid, 'shared', 'not-shared'))
}
testcase('array#issquare()') {
	tester(`array.zeros([]).issquare())
	tester(`array.zeros([3]).issquare())
	tester(`array.zeros([3, 4]).issquare())
	tester(`array.zeros([3, 3]).issquare())
	tester(`array.zeros([2, 4, 3, 3]).issquare())
	tester(`array.zeros([2, 4, 3, 2]).issquare())
}
testcase('pointer') {
	x = array@int8.range(24).reshape([2, 3, 4])
	p = x.p
	p.dump()
	p += 10
	printf('%02x\n', p.get@int8())
	printf('%02x\n', p.get@int8())
	printf('%04x\n', p.get@int16())
	printf('%08x\n', p.get@int32())
}
testcase('index-get') {
	x = array.range(48).reshape([6, nil])
	println(x)
	tester(`x[0])
	tester(`x[5])
	tester(`x[0, 0])
	tester(`x[5, 0])
	tester(`x[5, 7])
	tester(`x[0, 7])
	tester(`x[2, 3])
	tester(`x[6, 0])
	tester(`x[0, 8])
	tester(`x[0, 2, 0])
	tester(`x[1..4, 2..6])
	tester(`x[1..4])
	tester(`x[*, *])
	tester(`x[*, 2..6])
	tester(`x[1..4, *])
	tester(`x[1..4, 3])
	tester(`x[4, 2..6])
}
testcase('index-set') {
	array.zeros([6, 8]) {|x|
		x[] = 3
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[0] = 1
		x[1] = 2
		x[2] = 3
		x[3] = 4
		x[4] = 5
		x[5] = 6
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[2..4] = 3
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[0, 0] = 1
		x[5, 7] = 2
		x[5, 0] = 3
		x[0, 7] = 4
		x[1..4, 2..6] = 5
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[*, *] = 3
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[*, 2..6] = 3
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1..4, *] = 3
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1..4, 3] = 3
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[4, 2..6] = 3
		println(x)
	}
}
testcase('index-set with iterator assigned') {
	array.zeros([6, 8]) {|x|
		x[1] = 1..
		x[3] = 1..
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1, 1..5] = 1..
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1..4, 3] = 1..
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1..4, 1..5] = 1..
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1..3, 1..3] = [1, 2, 3, 4, 5, 6, 7, 8, 9]
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1..3, 1..3] = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1..3, 1..3] = [[1, 2, [3]], [[4, 5, 6, 7], [8, 9]]]
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1.., 1] = 1..
		x[1.., 5] = 6..
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[*, *] = 1..
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[*, 2..6] = 1..
		println(x)
	}
	array.zeros([6, 8]) {|x|
		x[1..4, *] = 1..
		println(x)
	}
}
