#!/usr/bin/env gura
import(helper.test) {*}
import(re)
import(doxygen)

TestCaseInfo = struct(title:string, doc:string)

testCaseInfos = []

testcase(title:string, doc:string):void = {
	testCaseInfos.add(TestCaseInfo(title, doc))
}

testcase('blank block comment', R'''
/**/
''')

testcase('blank line comment', R'''
//
''')

testcase('simple doxygen block', R'''
/**
*/

/*!
*/

/** test1
*/

/*! test1
*/

/**
 test2
*/

/*!
 test2
*/

/**
test3 */

/*!
test3 */
''')

testcase('simple doxygen line', R'''
//!

///

//! test1

/// test1
''')

testcase('multiline', R'''
/**
line.1
line.2
line.3
*/
''')

testcase('blank line test', R'''
/*!
 * abcdefg
 * hijklmn
 *
 * opqrstu
 */
''')

testcase('split comments', R'''
/*!
 abcdef
 */
/*!
 ghijkl
 */
/*!
 mnopqr
 */
/*!
 stuvwxyz
 */
''')

testcase('punctuation', R'''
/*!
\a 1st.2nd \a 1st. 2nd
\a 1st,2nd \a 1st, 2nd
\a 1st;2nd \a 1st; 2nd
\a 1st?2nd \a 1st? 2nd
\a 1st!2nd \a 1st! 2nd
*/
''')

testcase('quotation', R'''
/*!
\a word
\a "word"
\a "multi words"
*/
''')

testcase('test of @addtogroup', R'''
/*! \addtogroup mygrp
 *  Additional documentation for group 'mygrp'
 */

/*!
 *  A function
 */
void func1()
{
}

/*! Another function */
void func2()
{
}
''')

testcase('test of @class', R'''
/* A dummy class */
class Test
{
};
/*! \class Test class.h "inc/class.h"
 *  \brief This is a test class.
 *
 * Some details about the Test class.
 */
''')

testcase('test of @def', R'''
/*! \file define.h
    \brief testing defines
    
    This is to test the documentation of defines.
*/
/*!
  \def MAX(x,y)
  Computes the maximum of \a x and \a y.
*/
/*! 
   Computes the absolute value of its argument \a x.
*/
#define ABS(x) (((x)>0)?(x):-(x))
#define MAX(x,y) ((x)>(y)?(x):(y))
#define MIN(x,y) ((x)>(y)?(y):(x)) 
        /*!< Computes the minimum of \a x and \a y. */
''')

testcase('test of @enum', R'''
/*! \class Enum_Test
 * The class description.
 */
/*! \enum Enum_Test::TEnum
 * A description of the enum type.
 */
/*! \var Enum_Test::TEnum Enum_Test::Val1
 * The description of the first enum value.
 */
 ''')

testcase('test of @example', R'''
/** A Example_Test class.
 *  More details about this class.
 */
class Example_Test
{
  public:
    /** An example member function.
     *  More details about this function.
     */
    void example();
};
void Example_Test::example() {}
/** \example example_test.cpp
 * This is an example of how to use the Example_Test class.
 * More details about this example.
 */
''')

testcase('test of @file', R'''
/** \file file.h
 * A brief file description.
 * A more elaborated file description.
 */
/**
 * A global integer value.
 * More details about this value.
 */
extern int globalValue;
''')

testcase('test of @fn', R'''
/*! \class Fn_Test
 * \brief Fn_Test class.
 *
 * Details about Fn_Test.
 */
/*! \fn const char *Fn_Test::member(char c,int n) 
 *  \brief A member function.
 *  \param c a character.
 *  \param n an integer.
 *  \exception std::out_of_range parameter is out of range.
 *  \return a character pointer.
 */
''')

testcase('', R'''
E.g. if you have two event handlers @c A and @c B and a wxWindow instance
@c W and you call:
@code
    W->PushEventHandler(A);
    W->PushEventHandler(B);
@endcode
you will end up with the following situation:
    @image html overview_events_winstack.png
''')

/*
testcase('', R'''
''')
*/

Parser = class(doxygen.parser) {
	__init__(extractedFlag:boolean => false) = {|extractedFlag|}
	//--------------------------------------------------------------------------
	@l_1(name) = '@ref ${name}'.embed()
	@l_2(name, text) = '@ref ${name} "${text}"'.embed()
	@Bold_1(str) = '<b>${str}</b>'.embed()
	@Emph_1(str) = '<em>${str}</em>'.embed()
	@bar() = 'bar'
	@strong_1(a) = '@b ' + a
	@foo_3(a, b, c) = 'foo: %s,%s,%s' % [a, b, c]
	@customA_1(a) = 'customA ' + a
	@customB_1(a) = 'customB ' + a
}

testCaseInfos.each {|testCaseInfo, idx|
	(idx > 0) && println()
	printf('======== #%d', idx + 1)
	!testCaseInfo.title.isempty() && printf(' %s', testCaseInfo.title)
	println(' ========')
	extractedFlag = testCaseInfo.doc.isempty() || !testCaseInfo.doc.match(r'\s*/')
	elem = Parser(extractedFlag).parse(testCaseInfo.doc.reader())
	elem.print()
	println('--end--')
}
